#!/usr/bin/env bash

build=Release
srcdir=$HOME/src/hypertable

usage_exit() {
  echo "Usage: htpkg [Options] <generator>..."
  echo ""
  echo "Options:"
  echo "  --build <type>        Build type: Release|Debug|RelWithDebInfo"
  echo "  --srcdir <dir>        Hypertable source directory"
  echo ""
  exit $1
}

while [ "$1" != "${1##-}" ]; do
  case $1 in
    --build)    build=$2;       shift;;
    --srcdir)   srcdir=$2;      shift;;
    *)          usage_exit 1
  esac
  shift
done

gitrev=`git show --abbrev-commit | grep commit | sed "s/[^\w]* //"`
opts="-DCMAKE_BUILD_TYPE=$build BUILD_SHARED_LIBS=ON"
packopts = "-DCPACK_PACKAGE_VENDOR=K7 Computing \
-DCPACK_PACKAGE_DESCRIPTION_SUMMARY=HyperTable DFS Storage packaged for Cyclozzo Platform \
-DCPACK_PACKAGE_VERSION_PATCH=cyclozzo.git.$gitrev"

for gen in "$@"; do
  echo ----
  echo Building Revision: $gitrev
  echo Configuration: $build
  echo Generator: $gen
  echo ----
  cmake $opts $srcdir
  cpack $packopts -G $gen
done
